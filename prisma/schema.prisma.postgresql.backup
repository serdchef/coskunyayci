// Baklava Platform - Veritabanı Şeması
// PostgreSQL + Prisma ORM

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  // Local development uses SQLite (file-based, no Docker needed).
  // For production, change provider back to "postgresql" and update DATABASE_URL.
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// KULLANICI YÖNETİMİ
// ============================================================================

enum UserRole {
  CUSTOMER      // Normal müşteri
  ADMIN         // Sistem yöneticisi
  OPERATOR      // Sipariş operatörü
  SUPER_ADMIN   // Süper yönetici
}

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  name          String?
  phone         String?   @unique
  password      String?   // Hashed with bcrypt
  role          UserRole  @default(CUSTOMER)
  locale        String    @default("tr") // tr, en
  
  // İlişkiler
  orders        Order[]
  accounts      Account[]
  sessions      Session[]
  
  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  isActive      Boolean   @default(true)
  
  @@index([email])
  @@index([phone])
  @@map("users")
}

// NextAuth için Account ve Session modelleri
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// ÜRÜN YÖNETİMİ
// ============================================================================

enum ProductCategory {
  CLASSIC       // Klasik baklava
  SPECIAL       // Özel baklava
  CHOCOLATE     // Çikolatalı
  PISTACHIOS    // Antep fıstıklı
  WRAPPED       // Sarma
  DESSERT       // Tatlı çeşitleri
}

model Product {
  id          String          @id @default(cuid())
  sku         String          @unique // Örn: FISTIK_1KG
  name        String
  nameEn      String?
  description String          @db.Text
  descriptionEn String?       @db.Text
  category    ProductCategory
  
  // Fiyatlandırma (kuruş cinsinden)
  priceCents  Int
  taxRate     Float           @default(0.18) // KDV oranı
  
  // Ürün özellikleri
  weightGr    Int             // Gram
  ingredients String          @db.Text // Malzemeler listesi
  allergens   String?         // Alerjen bilgisi
  
  // Stok ve görünürlük
  stockQty    Int             @default(0)
  isActive    Boolean         @default(true)
  isFeatured  Boolean         @default(false)
  
  // Medya
  imageUrl    String?
  images      Json?           // Ek görseller array
  
  // Metadata
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([sku])
  @@index([category, isActive])
  @@map("products")
}

// ============================================================================
// SİPARİŞ YÖNETİMİ
// ============================================================================

enum OrderStatus {
  PENDING       // Beklemede
  CONFIRMED     // Onaylandı
  PREPARING     // Hazırlanıyor
  READY         // Hazır
  IN_DELIVERY   // Yolda
  DELIVERED     // Teslim edildi
  CANCELLED     // İptal edildi
  REFUNDED      // İade edildi
}

enum PaymentMethod {
  CASH          // Kapıda ödeme
  CREDIT_CARD   // Kredi kartı (Stripe)
  BANK_TRANSFER // Banka havalesi
  IYZICO        // iyzico
}

enum PaymentStatus {
  PENDING       // Ödeme bekliyor
  PROCESSING    // İşleniyor
  PAID          // Ödendi
  FAILED        // Başarısız
  REFUNDED      // İade edildi
}

enum DeliveryType {
  PICKUP        // Mağazadan teslim
  DELIVERY      // Adrese teslimat
}

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique // BK-20250101-0001
  
  // Müşteri bilgileri
  userId          String?
  user            User?         @relation(fields: [userId], references: [id])
  customerName    String
  customerPhone   String
  customerEmail   String?
  
  // Ürünler (JSON array of {sku, name, qty, priceCents, options})
  items           Json
  
  // Fiyat detayları (kuruş cinsinden)
  subtotalCents   Int           // Ara toplam
  taxCents        Int           // Vergi
  discountCents   Int           @default(0) // İndirim
  deliveryFeeCents Int          @default(0) // Teslimat ücreti
  totalCents      Int           // Genel toplam
  
  // Durum
  status          OrderStatus   @default(PENDING)
  
  // Teslimat
  deliveryType    DeliveryType
  address         Json?         // {street, district, city, postalCode, notes}
  deliveryDate    DateTime?
  deliveryNotes   String?       @db.Text
  
  // Ödeme
  paymentMethod   PaymentMethod
  paymentStatus   PaymentStatus @default(PENDING)
  paymentIntentId String?       // Stripe Payment Intent ID
  paidAt          DateTime?
  
  // Kupon
  couponCode      String?
  coupon          Coupon?       @relation(fields: [couponCode], references: [code])
  
  // Bildirimler
  notificationsSent Json?       // [{type: 'sms', sentAt, status}]
  
  // Metadata
  source          String        @default("chatbot") // chatbot, web, phone
  ipAddress       String?
  userAgent       String?
  notes           String?       @db.Text
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([customerPhone])
  @@map("orders")
}

// ============================================================================
// KUPON VE KAMPANYA YÖNETİMİ
// ============================================================================

enum CouponType {
  PERCENTAGE    // Yüzde indirim
  FIXED_AMOUNT  // Sabit tutar
  FREE_SHIPPING // Ücretsiz kargo
}

model Coupon {
  code            String      @id @unique
  type            CouponType
  
  // İndirim değeri
  discountPercent Float?      // Örn: 10 = %10
  discountAmount  Int?        // Kuruş cinsinden
  
  // Geçerlilik
  isActive        Boolean     @default(true)
  validFrom       DateTime?
  validTo         DateTime?
  
  // Kullanım limitleri
  usageLimit      Int?        // Maksimum kullanım sayısı
  usageCount      Int         @default(0)
  minOrderAmount  Int?        // Minimum sipariş tutarı (kuruş)
  maxDiscountAmount Int?      // Maksimum indirim tutarı (kuruş)
  
  // İlişkili ürünler/kategoriler
  applicableProducts String[]  // Product SKU'ları
  
  // İlişkiler
  orders          Order[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([code, isActive])
  @@map("coupons")
}

// ============================================================================
// VIDEO ÜRETİMİ VE REKLAM YÖNETİMİ
// ============================================================================

enum VideoJobStatus {
  PENDING       // Kuyrukta bekliyor
  PROCESSING    // İşleniyor
  COMPLETED     // Tamamlandı
  FAILED        // Başarısız
  CANCELLED     // İptal edildi
}

enum VideoProvider {
  RUNWAY        // Runway ML
  SYNTHESIA     // Synthesia
  STABLE_VIDEO  // Stable Video Diffusion
  INTERNAL      // Dahili üretim
}

model VideoJob {
  id            String          @id @default(cuid())
  jobId         String          @unique // Harici queue job ID
  
  // Template ve parametreler
  templateId    String
  templateName  String
  params        Json            // {productIds, duration, language, theme, etc.}
  
  // Durum
  status        VideoJobStatus  @default(PENDING)
  provider      VideoProvider
  
  // Sonuç
  resultUrl     String?
  thumbnailUrl  String?
  duration      Int?            // Saniye
  fileSize      Int?            // Bytes
  
  // Hata yönetimi
  errorMessage  String?         @db.Text
  retryCount    Int             @default(0)
  
  // Metadata
  createdBy     String?         // User ID
  campaignId    String?         // İlişkili kampanya
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  completedAt   DateTime?
  
  @@index([status])
  @@index([jobId])
  @@index([createdAt])
  @@map("video_jobs")
}

// ============================================================================
// ANALİTİK VE LOGLama
// ============================================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PAYMENT
  REFUND
  STATUS_CHANGE
  EXPORT
}

model AuditLog {
  id          String      @id @default(cuid())
  entity      String      // Örn: Order, User, Product
  entityId    String
  action      AuditAction
  payload     Json?       // Değişiklik detayları
  
  // Actor bilgisi
  actorId     String?     // User ID
  actorType   String?     // user, system, api
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime    @default(now())
  
  @@index([entity, entityId])
  @@index([actorId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Analitik events
model AnalyticsEvent {
  id          String   @id @default(cuid())
  eventName   String   // Örn: page_view, add_to_cart, order_placed
  properties  Json?
  userId      String?
  sessionId   String?
  
  // Metadata
  page        String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  
  createdAt   DateTime @default(now())
  
  @@index([eventName])
  @@index([userId])
  @@index([createdAt])
  @@map("analytics_events")
}

// ============================================================================
// SİSTEM AYARLARI
// ============================================================================

model Settings {
  key         String   @id
  value       Json
  description String?
  isPublic    Boolean  @default(false) // Public ayarlar frontend'de kullanılabilir
  
  updatedBy   String?
  updatedAt   DateTime @updatedAt
  
  @@map("settings")
}

// İşletme çalışma saatleri
model BusinessHours {
  id          String   @id @default(cuid())
  dayOfWeek   Int      // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi
  openTime    String   // "09:00"
  closeTime   String   // "22:00"
  isOpen      Boolean  @default(true)
  
  @@unique([dayOfWeek])
  @@map("business_hours")
}

// Notification records for messages sent to business/customers
model Notification {
  id           String   @id @default(cuid())
  orderId      String?  // optional link to order
  type         String   // whatsapp, sms, email
  to           String
  body         String
  status       String   @default("PENDING") // PENDING, SENT, FAILED
  messageId    String?  // provider message id (e.g., Twilio SID)
  error        String?  @db.Text
  attempts     Int      @default(0)
  lastAttemptAt DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([orderId])
  @@index([status])
  @@map("notifications")
}
