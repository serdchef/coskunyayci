generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String      @id @default(cuid())
  email       String      @unique
  password    String?
  name        String
  phone       String?
  role        String      @default("USER")
  locale      String      @default("tr")
  isActive    Boolean     @default(true)
  lastLoginAt DateTime?
  orders      Order[]
  addresses   Address[]
  b2bProfile  B2BProfile?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([email])
  @@index([role])
  @@map("users")
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  street    String
  city      String
  district  String
  zipCode   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("addresses")
}

model B2BProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName    String
  taxId          String   @unique
  department     String
  authorizedName String
  industry       String
  companySize    String   @default("SMALL")
  address        String?
  creditLimit    Float    @default(0)
  discountRate   Float    @default(0.15)
  approved       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([approved])
  @@map("b2b_profiles")
}

model Product {
  id          String           @id @default(cuid())
  sku         String           @unique
  name        String
  description String
  productType String
  category    String
  region      String
  basePrice   Float
  image       String
  variants    ProductVariant[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([category])
  @@index([productType])
  @@map("products")
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  size      String
  price     Float
  stock     Int      @default(100)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, size])
  @@map("product_variants")
}

model Order {
  id            String            @id @default(cuid())
  userId        String?
  user          User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  addressId     String?
  status        String            @default("CONFIRMED")
  totalPrice    Float
  items         OrderItem[]
  address       String?
  city          String?
  zipCode       String?
  district      String?
  courierName   String?           @default("Yola Çıkılıyor")
  courierPhone  String?
  locations     CourierLocation[]
  notifications Notification[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model CourierLocation {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  latitude  Float
  longitude Float
  address   String?
  status    String   @default("IN_TRANSIT")
  timestamp DateTime @default(now())

  @@index([orderId])
  @@map("courier_locations")
}

model Notification {
  id      String   @id @default(cuid())
  orderId String
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  type    String
  message String
  channel String   @default("EMAIL")
  sentAt  DateTime @default(now())
  read    Boolean  @default(false)

  @@index([orderId])
  @@index([type])
  @@map("notifications")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productName String
  quantity    Int
  price       Float
  createdAt   DateTime @default(now())

  @@map("order_items")
}

// Video production models
model VideoJob {
  id           String   @id @default(cuid())
  jobId        String   @unique
  templateId   String
  templateName String
  params       String // JSON as text for SQLite
  status       String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  provider     String // RUNWAY, SYNTHESIA, STABLE_VIDEO, INTERNAL
  resultUrl    String?
  thumbnailUrl String?
  duration     Int?
  fileSize     Int?
  errorMessage String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("video_jobs")
}
